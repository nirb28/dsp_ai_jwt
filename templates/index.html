<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DSPAI JWT Auth Portal</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/modern-normalize/2.0.0/modern-normalize.min.css">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            margin: 0;
            padding: 0;
        }
        .container {
            max-width: 1000px;
            background: #fff;
            margin: 48px auto;
            border-radius: 10px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.09);
            padding: 32px 28px 24px 28px;
        }
        h2 {
            text-align: center;
            margin-bottom: 28px;
            color: #34495e;
        }
        label {
            display: block;
            margin-bottom: 7px;
            color: #2c3e50;
        }
        input[type="text"], input[type="password"] {
            width: 100%;
            padding: 8px 10px;
            margin-bottom: 18px;
            border: 1px solid #d0d7de;
            border-radius: 5px;
            font-size: 1em;
        }
        button {
            width: 100%;
            background: #1976d2;
            color: #fff;
            border: none;
            border-radius: 5px;
            padding: 10px 0;
            font-size: 1.1em;
            cursor: pointer;
            margin-bottom: 12px;
            transition: background .2s;
        }
        button:hover {
            background: #115293;
        }
        .result, .error {
            margin-top: 18px;
            border-radius: 5px;
            padding: 12px;
            font-size: 0.98em;
            word-break: break-all;
        }
        .result {
            background: #e8f5e9;
            color: #2e7d32;
        }
        .error {
            background: #ffebee;
            color: #c62828;
        }
        .section {
            margin-bottom: 36px;
        }
        .subtitle {
            font-size: 1.08em;
            color: #1976d2;
            margin-bottom: 10px;
            font-weight: 500;
        }
        textarea {
            width: 100%;
            min-height: 60px;
            border-radius: 5px;
            border: 1px solid #d0d7de;
            padding: 7px 10px;
            font-size: 1em;
            margin-bottom: 10px;
        }
        .copy-btn {
            background: #4caf50;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 5px 10px;
            font-size: 0.9em;
            cursor: pointer;
            margin: 5px 0;
            display: inline-block;
            width: auto;
        }
        .copy-btn:hover {
            background: #388e3c;
        }
        .token-container {
            margin-top: 10px;
        }
        .token-row {
            margin-bottom: 10px;
        }
        .token-label {
            font-weight: bold;
            display: block;
            margin-bottom: 5px;
        }
        .token-value {
            background: #f1f8e9;
            padding: 8px;
            border-radius: 4px;
            word-break: break-all;
            border: 1px solid #c5e1a5;
            font-family: monospace;
            font-size: 0.9em;
            max-height: 80px;
            overflow-y: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
            font-size: 0.9em;
        }
        th, td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }
        th {
            background-color: #f5f5f5;
            font-weight: 500;
        }
        .action-btn {
            background: transparent;
            border: none;
            color: #2196f3;
            cursor: pointer;
            padding: 3px 8px;
            margin-right: 5px;
            border-radius: 3px;
            font-size: 0.85em;
        }
        .action-btn:hover {
            background: #e3f2fd;
        }
        .action-btn.delete {
            color: #f44336;
        }
        .action-btn.delete:hover {
            background: #ffebee;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 100;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .modal-title {
            font-size: 1.2em;
            font-weight: 500;
        }
        .close-btn {
            background: transparent;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            line-height: 1;
        }
        .field-group {
            margin-bottom: 15px;
        }
        .tabs {
            display: flex;
            margin-bottom: 15px;
            border-bottom: 1px solid #e0e0e0;
        }
        .tab {
            padding: 8px 15px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }
        .tab.active {
            border-bottom-color: #1976d2;
            color: #1976d2;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .api-key-value {
            font-family: monospace;
            background: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            word-break: break-all;
            border: 1px solid #e0e0e0;
        }
        /* Two-panel layout */
        .panels-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
        }
        .panel {
            flex: 1;
            min-width: 300px;
            padding: 20px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 1px 8px rgba(0,0,0,0.07);
        }
        .panel-title {
            font-size: 1.2em;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e0e0e0;
            color: #34495e;
        }
        .divider {
            border-left: 1px solid #e0e0e0;
            margin: 0 10px;
        }
        .api-docs-section {
            text-align: center;
            padding: 15px;
            margin-top: 20px;
            background: #f5f5f5;
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>DSPAI JWT Auth Portal</h2>
        
        <div class="panels-container">
            <!-- Left Panel - Token Generation -->
            <div class="panel">
                <div class="panel-title">Token Generation</div>
                
                <div class="section">
                    <div class="subtitle">Login to get JWT Token</div>
                    <form id="loginForm">
                        <label for="username">Username</label>
                        <input type="text" id="username" name="username" required>
                        <label for="password">Password</label>
                        <input type="password" id="password" name="password" required>
                        <label for="api_key">API Key (optional)</label>
                        <input type="text" id="api_key" name="api_key">
                        <label for="token_secret">Secret Key (optional)</label>
                        <input type="text" id="token_secret" name="token_secret" placeholder="Leave empty to use system default secret">
                        <button type="submit">Get Token</button>
                    </form>
                    <div id="tokenResult" class="result" style="display:none;">
                        <div class="token-container">
                            <div class="token-row">
                                <div class="token-label">Access Token:</div>
                                <div id="access-token" class="token-value"></div>
                                <button class="copy-btn" onclick="copyToClipboard('access-token')">Copy to Clipboard</button>
                            </div>
                            <div class="token-row">
                                <div class="token-label">Refresh Token:</div>
                                <div id="refresh-token" class="token-value"></div>
                                <button class="copy-btn" onclick="copyToClipboard('refresh-token')">Copy to Clipboard</button>
                            </div>
                        </div>
                    </div>
                    <div id="tokenError" class="error" style="display:none;"></div>
                </div>
                
                <div class="section" id="apiKeySection" style="display:none;">
                    <div class="subtitle">API Key Management</div>
                    <p style="font-size: 0.9em; margin-bottom: 15px; color: #555;">
                        Manage API keys (administrators only)
                    </p>
                    <button class="copy-btn" style="margin-bottom: 15px;" onclick="createApiKey()">Create New API Key</button>
                    
                    <div id="apiKeysTable" style="margin-top: 15px; overflow-x: auto;">
                        <table>
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Owner</th>
                                    <th>Providers</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="apiKeysBody">
                                <!-- API keys will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                    <div id="apiKeyError" class="error" style="display:none;"></div>
                </div>
            </div>
            
            <!-- Right Panel - Token Operations -->
            <div class="panel">
                <div class="panel-title">Token Operations</div>
                
                <div class="section">
                    <div class="subtitle">Decode & Validate Token</div>
                    <form id="decodeForm">
                        <label for="jwt_token">JWT Token</label>
                        <textarea id="jwt_token" name="jwt_token" required></textarea>
                        
                        <label for="jwt_secret">Secret Key (Optional)</label>
                        <input type="text" id="jwt_secret" name="jwt_secret" placeholder="Leave empty to use system default secret">
                        <div style="display: flex; align-items: center; margin-bottom: 10px;">
                            <input type="checkbox" id="skipVerification" name="skipVerification">
                            <label for="skipVerification" style="margin-left: 8px; font-size: 14px;">Skip signature verification (show content even if invalid)</label>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button type="submit" style="flex: 1;">Decode Token</button>
                            <button type="button" onclick="validateToken()" style="flex: 1; background: #673ab7;">Validate Signature</button>
                        </div>
                    </form>
                    <div id="decodeResult" class="result" style="display:none;"></div>
                    <div id="decodeError" class="error" style="display:none;"></div>
                    <div id="validateResult" class="result" style="display:none;">
                        <div style="margin-bottom: 12px; font-weight: 500;">Validation Results:</div>
                        <div id="validation-details"></div>
                    </div>
                </div>
                
                <div class="section">
                    <div class="subtitle">Refresh Access Token</div>
                    <form id="refreshForm">
                        <label for="refresh_token">Refresh Token</label>
                        <textarea id="refresh_token" name="refresh_token" required></textarea>
                        <button type="submit">Get New Access Token</button>
                    </form>
                    <div id="refreshResult" class="result" style="display:none;">
                        <div class="token-container">
                            <div class="token-row">
                                <div class="token-label">New Access Token:</div>
                                <div id="new-access-token" class="token-value"></div>
                                <button class="copy-btn" onclick="copyToClipboard('new-access-token')">Copy to Clipboard</button>
                            </div>
                        </div>
                    </div>
                    <div id="refreshError" class="error" style="display:none;"></div>
                </div>
                
                <div class="section">
                    <div class="subtitle">Test Token Freshness (Sensitive Action)</div>
                    <p style="font-size: 0.9em; margin-bottom: 15px; color: #555;">
                        This demonstrates token freshness. Only tokens from direct login work here, not tokens from refresh.
                    </p>
                    <form id="sensitiveForm">
                        <label for="sensitive_token">Access Token</label>
                        <textarea id="sensitive_token" name="sensitive_token" required></textarea>
                        <button type="submit">Perform Sensitive Action</button>
                    </form>
                    <div id="sensitiveResult" class="result" style="display:none;"></div>
                    <div id="sensitiveError" class="error" style="display:none;"></div>
                </div>
            </div>
        </div>
        
        <div class="api-docs-section">
            <div class="subtitle">API Documentation</div>
            <p style="font-size: 0.9em; margin-bottom: 15px; color: #555;">
                Access the full API documentation with interactive testing capabilities.
            </p>
            <a href="/dspai-docs" target="_blank" style="display: inline-block; background: #4CAF50; color: white; padding: 8px 16px; text-decoration: none; border-radius: 4px; margin-top: 5px;">
                Open Swagger UI Documentation
            </a>
        </div>
    </div>
    
    <!-- API Key Create/Edit Modal -->
    <div id="apiKeyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">Create API Key</div>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <form id="apiKeyForm">
                <input type="hidden" id="apiKeyString" name="apiKeyString">
                <div class="field-group">
                    <label for="owner">Owner</label>
                    <input type="text" id="owner" name="owner" required>
                </div>
                
                <div class="tabs">
                    <div class="tab active" onclick="switchTab(event, 'basicTab')">Basic</div>
                    <div class="tab" onclick="switchTab(event, 'permissionsTab')">Permissions</div>
                    <div class="tab" onclick="switchTab(event, 'claimsTab')">Claims</div>
                </div>
                
                <div id="basicTab" class="tab-content active">
                    <div class="field-group">
                        <label>Provider Permissions</label>
                        <div>
                            <input type="checkbox" id="openai" name="provider_openai" checked>
                            <label for="openai">OpenAI</label>
                        </div>
                        <div>
                            <input type="checkbox" id="groq" name="provider_groq">
                            <label for="groq">Groq</label>
                        </div>
                        <div>
                            <input type="checkbox" id="anthropic" name="provider_anthropic">
                            <label for="anthropic">Anthropic</label>
                        </div>
                    </div>
                </div>
                
                <div id="permissionsTab" class="tab-content">
                    <div class="field-group">
                        <label>Endpoint Permissions</label>
                        <div>
                            <input type="checkbox" id="chat_completions" name="endpoint_chat_completions" checked>
                            <label for="chat_completions">/v1/chat/completions</label>
                        </div>
                        <div>
                            <input type="checkbox" id="embeddings" name="endpoint_embeddings" checked>
                            <label for="embeddings">/v1/embeddings</label>
                        </div>
                        <div>
                            <input type="checkbox" id="completions" name="endpoint_completions">
                            <label for="completions">/v1/completions</label>
                        </div>
                    </div>
                </div>
                
                <div id="claimsTab" class="tab-content">
                    <div class="field-group">
                        <label for="models">Models (comma-separated)</label>
                        <input type="text" id="models" name="models" value="gpt-3.5-turbo">
                    </div>
                    <div class="field-group">
                        <label for="rate_limit">Rate Limit</label>
                        <input type="number" id="rate_limit" name="rate_limit" value="20" min="1">
                    </div>
                    <div class="field-group">
                        <label for="tier">Tier</label>
                        <select id="tier" name="tier">
                            <option value="standard" selected>Standard</option>
                            <option value="premium">Premium</option>
                            <option value="enterprise">Enterprise</option>
                        </select>
                    </div>
                    <div class="field-group">
                        <label for="exp_hours">Token Expiration (hours)</label>
                        <input type="number" id="exp_hours" name="exp_hours" value="1" min="1">
                    </div>
                </div>
                
                <button type="submit">Save API Key</button>
            </form>
            
            <div id="apiKeyResult" class="result" style="display:none;">
                <div class="field-group">
                    <label>API Key (copy this, it won't be shown again)</label>
                    <div id="newApiKey" class="api-key-value"></div>
                    <button class="copy-btn" style="margin-top: 10px;" onclick="copyToClipboard('newApiKey')">Copy to Clipboard</button>
                </div>
            </div>
            <div id="modalError" class="error" style="display:none;"></div>
        </div>
    </div>
    
    <script>
        // Copy to clipboard function
        function copyToClipboard(elementId) {
            const element = document.getElementById(elementId);
            const textToCopy = element.textContent;
            
            if (navigator.clipboard) {
                navigator.clipboard.writeText(textToCopy)
                    .then(() => {
                        const btn = element.nextElementSibling;
                        const originalText = btn.textContent;
                        btn.textContent = "Copied!";
                        setTimeout(() => {
                            btn.textContent = originalText;
                        }, 1500);
                    })
                    .catch(err => {
                        console.error('Failed to copy: ', err);
                    });
            } else {
                // Fallback for older browsers
                const textArea = document.createElement("textarea");
                textArea.value = textToCopy;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand("copy");
                document.body.removeChild(textArea);
                
                const btn = element.nextElementSibling;
                const originalText = btn.textContent;
                btn.textContent = "Copied!";
                setTimeout(() => {
                    btn.textContent = originalText;
                }, 1500);
            }
        }
        
        // Login form handler
        document.getElementById('loginForm').onsubmit = async function(e) {
            e.preventDefault();
            document.getElementById('tokenResult').style.display = 'none';
            document.getElementById('tokenError').style.display = 'none';
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const api_key = document.getElementById('api_key').value;
            const secret = document.getElementById('token_secret').value.trim();
            const payload = { username, password };
            if (api_key) payload.api_key = api_key;
            if (secret) payload.secret = secret;
            try {
                const resp = await fetch('/token', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await resp.json();
                if (resp.ok) {
                    document.getElementById('access-token').textContent = data.access_token;
                    document.getElementById('refresh-token').textContent = data.refresh_token;
                    document.getElementById('tokenResult').style.display = 'block';
                    
                    // Auto-fill refresh token field for convenience
                    document.getElementById('refresh_token').value = data.refresh_token;
                } else {
                    document.getElementById('tokenError').textContent = data.error || 'Login failed';
                    document.getElementById('tokenError').style.display = 'block';
                }
            } catch (err) {
                document.getElementById('tokenError').textContent = 'Network or server error.';
                document.getElementById('tokenError').style.display = 'block';
            }
        };
        
        // Decode form handler
        document.getElementById('decodeForm').onsubmit = async function(e) {
            e.preventDefault();
            document.getElementById('decodeResult').style.display = 'none';
            document.getElementById('decodeError').style.display = 'none';
            document.getElementById('validateResult').style.display = 'none';
            const token = document.getElementById('jwt_token').value;
            const skipVerification = document.getElementById('skipVerification').checked;
            const secret = document.getElementById('jwt_secret').value.trim();
            try {
                const resp = await fetch('/decode', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token, skipVerification, secret: secret || null })
                });
                const data = await resp.json();
                if (resp.ok) {
                    document.getElementById('decodeResult').textContent = JSON.stringify(data, null, 2);
                    document.getElementById('decodeResult').style.display = 'block';
                } else {
                    document.getElementById('decodeError').textContent = data.error || 'Decode failed';
                    document.getElementById('decodeError').style.display = 'block';
                }
            } catch (err) {
                document.getElementById('decodeError').textContent = 'Network or server error.';
                document.getElementById('decodeError').style.display = 'block';
            }
        };
        
        // Signature validation handler
        async function validateToken() {
            document.getElementById('decodeResult').style.display = 'none';
            document.getElementById('decodeError').style.display = 'none';
            document.getElementById('validateResult').style.display = 'none';
            
            const token = document.getElementById('jwt_token').value;
            if (!token) {
                document.getElementById('decodeError').textContent = 'Please enter a token to validate';
                document.getElementById('decodeError').style.display = 'block';
                return;
            }
            
            try {
                const resp = await fetch('/validate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token })
                });
                
                const data = await resp.json();
                
                // Create a styled validation result
                let resultHtml = '';
                
                if (data.valid) {
                    resultHtml += `<div style="color: #2e7d32; margin-bottom: 8px;"><strong>✓ Valid JWT Token</strong></div>`;
                    resultHtml += `<div><strong>Signature:</strong> <span style="color: #2e7d32;">Verified</span></div>`;
                    resultHtml += data.expired ? 
                        `<div><strong>Expiration:</strong> <span style="color: #c62828;">Token expired</span></div>` :
                        `<div><strong>Expiration:</strong> <span style="color: #2e7d32;">Valid (not expired)</span></div>`;
                    
                    resultHtml += `<div><strong>Expiry Time:</strong> ${data.expiry_time}</div>`;
                    resultHtml += `<div><strong>Issued At:</strong> ${data.issued_at}</div>`;
                    
                    if (data.issuer !== 'Not specified') {
                        resultHtml += `<div><strong>Issuer:</strong> ${data.issuer}</div>`;
                    }
                    
                    if (data.subject !== 'Not specified') {
                        resultHtml += `<div><strong>Subject:</strong> ${data.subject}</div>`;
                    }
                } else {
                    resultHtml += `<div style="color: #c62828; margin-bottom: 8px;"><strong>✗ Invalid JWT Token</strong></div>`;
                    
                    if (!data.signature_verified) {
                        resultHtml += `<div><strong>Signature:</strong> <span style="color: #c62828;">Invalid - token may be tampered with or using wrong secret key</span></div>`;
                    }
                    
                    if (data.expired) {
                        resultHtml += `<div><strong>Expiration:</strong> <span style="color: #c62828;">Token expired</span></div>`;
                    }
                    
                    resultHtml += `<div><strong>Error Details:</strong> ${data.error}</div>`;
                }
                
                document.getElementById('validation-details').innerHTML = resultHtml;
                document.getElementById('validateResult').style.display = 'block';
                
            } catch (err) {
                document.getElementById('decodeError').textContent = 'Network or server error during validation.';
                document.getElementById('decodeError').style.display = 'block';
            }
        }
        
        // Refresh token handler
        document.getElementById('refreshForm').onsubmit = async function(e) {
            e.preventDefault();
            document.getElementById('refreshResult').style.display = 'none';
            document.getElementById('refreshError').style.display = 'none';
            const refreshToken = document.getElementById('refresh_token').value;
            try {
                const resp = await fetch('/refresh', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${refreshToken}`
                    }
                });
                const data = await resp.json();
                if (resp.ok) {
                    document.getElementById('new-access-token').textContent = data.access_token;
                    document.getElementById('refreshResult').style.display = 'block';
                    
                    // Update the decode section for convenience
                    document.getElementById('jwt_token').value = data.access_token;
                    
                    // Also update the sensitive action token field for testing
                    document.getElementById('sensitive_token').value = data.access_token;
                } else {
                    document.getElementById('refreshError').textContent = data.error || 'Refresh token failed';
                    document.getElementById('refreshError').style.display = 'block';
                }
            } catch (err) {
                document.getElementById('refreshError').textContent = 'Network or server error.';
                document.getElementById('refreshError').style.display = 'block';
            }
        };
        
        // Sensitive action handler
        document.getElementById('sensitiveForm').onsubmit = async function(e) {
            e.preventDefault();
            document.getElementById('sensitiveResult').style.display = 'none';
            document.getElementById('sensitiveError').style.display = 'none';
            
            const token = document.getElementById('sensitive_token').value;
            try {
                const resp = await fetch('/sensitive-action', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    }
                });
                const data = await resp.json();
                if (resp.ok) {
                    document.getElementById('sensitiveResult').textContent = JSON.stringify(data, null, 2);
                    document.getElementById('sensitiveResult').style.display = 'block';
                } else {
                    document.getElementById('sensitiveError').textContent = data.error || 'Token not fresh - sensitive action denied';
                    document.getElementById('sensitiveError').style.display = 'block';
                }
            } catch (err) {
                document.getElementById('sensitiveError').textContent = 'Network or server error.';
                document.getElementById('sensitiveError').style.display = 'block';
            }
        };
        
        // Auto-populate the sensitive token field when getting a token from login
        document.getElementById('loginForm').addEventListener('submit', function() {
            setTimeout(() => {
                if (document.getElementById('access-token').textContent) {
                    document.getElementById('sensitive_token').value = document.getElementById('access-token').textContent;
                }
            }, 500); // Small delay to ensure the token is populated first
        });
        
        // Check if user is an admin and show API key management section
        function checkAdminAccess() {
            const token = document.getElementById('access-token').textContent;
            if (!token) return;
            
            try {
                // Parse JWT payload (middle part)
                const payload = JSON.parse(atob(token.split('.')[1]));
                const groups = payload.groups || [];
                
                if (groups.includes('administrators') || groups.includes('admins')) {
                    document.getElementById('apiKeySection').style.display = 'block';
                    loadApiKeys();
                }
            } catch (err) {
                console.error('Error checking admin access:', err);
            }
        }
        
        // Load API keys when token is received
        document.getElementById('loginForm').addEventListener('submit', function() {
            setTimeout(checkAdminAccess, 1000);
        });
        
        // Load API keys
        async function loadApiKeys() {
            const token = document.getElementById('access-token').textContent;
            if (!token) return;
            
            try {
                const resp = await fetch('/api-keys', {
                    method: 'GET',
                    headers: { 
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (resp.ok) {
                    const apiKeys = await resp.json();
                    const tbody = document.getElementById('apiKeysBody');
                    tbody.innerHTML = '';
                    
                    apiKeys.forEach(key => {
                        const tr = document.createElement('tr');
                        
                        // Extract API key string from filename
                        const apiKeyString = key.filename.replace('.yaml', '');
                        
                        tr.innerHTML = `
                            <td>${key.id}</td>
                            <td>${key.owner}</td>
                            <td>${key.provider_permissions.join(', ')}</td>
                            <td>
                                <button class="action-btn" onclick="editApiKey('${apiKeyString}')">Edit</button>
                                <button class="action-btn delete" onclick="deleteApiKey('${apiKeyString}')">Delete</button>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                    
                    if (apiKeys.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="4" style="text-align:center">No API keys found</td></tr>';
                    }
                } else {
                    const data = await resp.json();
                    document.getElementById('apiKeyError').textContent = data.error || 'Failed to load API keys';
                    document.getElementById('apiKeyError').style.display = 'block';
                }
            } catch (err) {
                document.getElementById('apiKeyError').textContent = 'Network or server error';
                document.getElementById('apiKeyError').style.display = 'block';
            }
        }
        
        // Open modal to create new API key
        function createApiKey() {
            document.getElementById('modalTitle').textContent = 'Create API Key';
            document.getElementById('apiKeyForm').reset();
            document.getElementById('apiKeyString').value = '';
            document.getElementById('apiKeyResult').style.display = 'none';
            document.getElementById('modalError').style.display = 'none';
            
            // Switch to first tab
            switchTab(null, 'basicTab');
            
            document.getElementById('apiKeyModal').style.display = 'flex';
        }
        
        // Edit API key
        async function editApiKey(apiKeyString) {
            const token = document.getElementById('access-token').textContent;
            if (!token) return;
            
            document.getElementById('modalTitle').textContent = 'Edit API Key';
            document.getElementById('apiKeyForm').reset();
            document.getElementById('apiKeyString').value = apiKeyString;
            document.getElementById('apiKeyResult').style.display = 'none';
            document.getElementById('modalError').style.display = 'none';
            
            try {
                // Load API key details
                const resp = await fetch(`/api-keys/${apiKeyString}`, {
                    method: 'GET',
                    headers: { 
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (resp.ok) {
                    const key = await resp.json();
                    
                    // Fill form with API key data
                    document.getElementById('owner').value = key.owner || '';
                    
                    // Set provider permissions
                    const providers = key.provider_permissions || [];
                    document.getElementById('openai').checked = providers.includes('openai');
                    document.getElementById('groq').checked = providers.includes('groq');
                    document.getElementById('anthropic').checked = providers.includes('anthropic');
                    
                    // Set endpoint permissions
                    const endpoints = key.endpoint_permissions || [];
                    document.getElementById('chat_completions').checked = endpoints.includes('/v1/chat/completions');
                    document.getElementById('embeddings').checked = endpoints.includes('/v1/embeddings');
                    document.getElementById('completions').checked = endpoints.includes('/v1/completions');
                    
                    // Set claims
                    const staticClaims = key.claims?.static || {};
                    document.getElementById('models').value = staticClaims.models?.join(', ') || 'gpt-3.5-turbo';
                    document.getElementById('rate_limit').value = staticClaims.rate_limit || 20;
                    document.getElementById('tier').value = staticClaims.tier || 'standard';
                    document.getElementById('exp_hours').value = staticClaims.exp_hours || 1;
                    
                    // Switch to first tab
                    switchTab(null, 'basicTab');
                    
                    document.getElementById('apiKeyModal').style.display = 'flex';
                } else {
                    const data = await resp.json();
                    document.getElementById('apiKeyError').textContent = data.error || 'Failed to load API key details';
                    document.getElementById('apiKeyError').style.display = 'block';
                }
            } catch (err) {
                document.getElementById('apiKeyError').textContent = 'Network or server error';
                document.getElementById('apiKeyError').style.display = 'block';
            }
        }
        
        // Delete API key
        async function deleteApiKey(apiKeyString) {
            if (!confirm('Are you sure you want to delete this API key? This action cannot be undone.')) {
                return;
            }
            
            const token = document.getElementById('access-token').textContent;
            if (!token) return;
            
            try {
                const resp = await fetch(`/api-keys/${apiKeyString}`, {
                    method: 'DELETE',
                    headers: { 
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (resp.ok) {
                    loadApiKeys();
                } else {
                    const data = await resp.json();
                    document.getElementById('apiKeyError').textContent = data.error || 'Failed to delete API key';
                    document.getElementById('apiKeyError').style.display = 'block';
                }
            } catch (err) {
                document.getElementById('apiKeyError').textContent = 'Network or server error';
                document.getElementById('apiKeyError').style.display = 'block';
            }
        }
        
        // Close modal
        function closeModal() {
            document.getElementById('apiKeyModal').style.display = 'none';
        }
        
        // Switch tabs in modal
        function switchTab(event, tabId) {
            if (event) {
                event.preventDefault();
            }
            
            // Hide all tab contents
            const tabContents = document.getElementsByClassName('tab-content');
            for (let i = 0; i < tabContents.length; i++) {
                tabContents[i].classList.remove('active');
            }
            
            // Remove active class from all tabs
            const tabs = document.getElementsByClassName('tab');
            for (let i = 0; i < tabs.length; i++) {
                tabs[i].classList.remove('active');
            }
            
            // Show selected tab content
            document.getElementById(tabId).classList.add('active');
            
            // Add active class to selected tab
            if (event) {
                event.currentTarget.classList.add('active');
            } else {
                // Find tab by tabId and add active class
                const tab = document.querySelector(`.tab[onclick*="${tabId}"]`);
                if (tab) tab.classList.add('active');
            }
        }
        
        // Handle API key form submission
        document.getElementById('apiKeyForm').onsubmit = async function(e) {
            e.preventDefault();
            document.getElementById('apiKeyResult').style.display = 'none';
            document.getElementById('modalError').style.display = 'none';
            
            const token = document.getElementById('access-token').textContent;
            if (!token) return;
            
            // Get form data
            const owner = document.getElementById('owner').value;
            
            // Get provider permissions
            const providerPermissions = [];
            if (document.getElementById('openai').checked) providerPermissions.push('openai');
            if (document.getElementById('groq').checked) providerPermissions.push('groq');
            if (document.getElementById('anthropic').checked) providerPermissions.push('anthropic');
            
            // Get endpoint permissions
            const endpointPermissions = [];
            if (document.getElementById('chat_completions').checked) endpointPermissions.push('/v1/chat/completions');
            if (document.getElementById('embeddings').checked) endpointPermissions.push('/v1/embeddings');
            if (document.getElementById('completions').checked) endpointPermissions.push('/v1/completions');
            
            // Get models
            const modelsInput = document.getElementById('models').value;
            const models = modelsInput.split(',').map(m => m.trim()).filter(m => m);
            
            // Create payload
            const payload = {
                owner,
                provider_permissions: providerPermissions,
                endpoint_permissions: endpointPermissions,
                static_claims: {
                    models,
                    rate_limit: parseInt(document.getElementById('rate_limit').value, 10),
                    tier: document.getElementById('tier').value,
                    exp_hours: parseInt(document.getElementById('exp_hours').value, 10)
                }
            };
            
            // Get API key string for edit mode
            const apiKeyString = document.getElementById('apiKeyString').value;
            
            try {
                let resp;
                
                if (apiKeyString) {
                    // Update existing API key
                    resp = await fetch(`/api-keys/${apiKeyString}`, {
                        method: 'PUT',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(payload)
                    });
                } else {
                    // Create new API key
                    resp = await fetch('/api-keys', {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(payload)
                    });
                }
                
                const data = await resp.json();
                
                if (resp.ok) {
                    if (!apiKeyString) {
                        // Show new API key
                        document.getElementById('newApiKey').textContent = data.api_key;
                        document.getElementById('apiKeyResult').style.display = 'block';
                    } else {
                        // Close modal after successful update
                        closeModal();
                    }
                    
                    // Reload API keys list
                    loadApiKeys();
                } else {
                    document.getElementById('modalError').textContent = data.error || 'Failed to save API key';
                    document.getElementById('modalError').style.display = 'block';
                }
            } catch (err) {
                document.getElementById('modalError').textContent = 'Network or server error';
                document.getElementById('modalError').style.display = 'block';
            }
        };
        
        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('apiKeyModal');
            if (event.target === modal) {
                closeModal();
            }
        };
    </script>
</body>
</html>
